<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Aprendiz - SENA</title>
    <link rel="stylesheet" href="/css/aprendiz-dashboard.css">
    <!-- Chart.js para gr√°ficos din√°micos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <img src="/img/logo2.png" alt="Logo SENA" style="width: 80px; height: 80px; margin-bottom: 15px; object-fit: contain;">
                <h2>üë®‚Äçüéì Aprendiz</h2>
            </div>
            <ul class="nav-menu">
                <li data-section="dashboard" class="nav-item active">
                    <span class="icon">üìä</span> Dashboard
                </li>
                <li data-section="registrar-proyecto" class="nav-item">
                    <span class="icon">üìù</span> Registrar Proyecto
                </li>
                <li data-section="entregar-entregables" class="nav-item">
                    <span class="icon">üóÇÔ∏è</span> Entregar Entregables
                </li>
                <li data-section="mis-calificaciones" class="nav-item">
                    <span class="icon">‚≠ê</span> Mis Calificaciones
                </li>
                <li data-section="mis-grupos" class="nav-item">
                    <span class="icon">üë•</span> Mis Grupos (GAES)
                </li>
                <li data-section="mensajes" class="nav-item">
                    <span class="icon">üí¨</span> Mensajes
                </li>
                <li data-section="notificaciones" class="nav-item">
                    <span class="icon">üì¢</span> Notificaciones
                </li>
                <li data-section="configuracion" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span> Configuraci√≥n
                </li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-box">
                    <input type="text" id="global-search" placeholder="Buscar...">
                </div>
                <div class="header-actions">
                     <div class="user-profile-header">
                         <span id="user-name-display" class="user-name">Usuario</span>
                     </div>
                     <button class="btn-icon" onclick="loadAprendizData()" title="Recargar datos">
                         <span class="icon">üîÑ</span>
                     </button>
                     <button class="btn-icon" onclick="toggleTheme()" title="Tema">
                         <span class="icon">üåó</span>
                     </button>
                     <button class="btn-action btn-danger" onclick="logout()" title="Cerrar sesi√≥n">
                         CERRAR SESI√ìN
                     </button>
                 </div>
            </div>

            <!-- Panel de Notificaciones -->
            <div id="notification-panel" class="notification-panel">
                <h3>Notificaciones Recientes</h3>
                <div id="notificaciones-list"></div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h1>Mi Dashboard</h1>
                <div id="dashboard-grid" class="dashboard-grid"></div>
                
                <!-- Secci√≥n de Gr√°ficos -->
                <div style="margin-top: 40px;">
                    <h2>Estad√≠sticas y An√°lisis</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- Gr√°fico de Calificaciones -->
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>Mi Promedio de Calificaciones</h3>
                            <canvas id="calificacionesChart"></canvas>
                        </div>
                        
                        <!-- Gr√°fico de Progreso -->
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>Progreso de Proyectos</h3>
                            <canvas id="proyectosChart"></canvas>
                        </div>
                        
                        <!-- Gr√°fico de Estado de Entregables -->
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>Estado de Entregables</h3>
                            <canvas id="entregablesChart"></canvas>
                        </div>
                        
                        <!-- Estad√≠sticas de GAES -->
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>Desempe√±o por Competencia</h3>
                            <canvas id="competenciasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registrar Proyecto -->
            <div id="registrar-proyecto" class="section">
                <h1>Registrar Proyecto</h1>
                <button class="btn-primary" onclick="abrirRegistrarProyecto()">
                    + Nuevo Proyecto
                </button>
                <div id="proyectos-list" class="cards-grid"></div>
            </div>

            <!-- Entregar Entregables -->
            <div id="entregar-entregables" class="section">
                <h1>Entregar Entregables</h1>
                <div class="filters">
                    <input type="text" id="entregables-search" placeholder="Buscar entregable...">
                    <select id="entregables-filter-estado">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Aprobado">Aprobado</option>
                        <option value="Devuelto">Devuelto</option>
                    </select>
                    <button class="btn-primary" onclick="openModal('modal-subir-entregable')">
                        + Subir Entregable
                    </button>
                </div>
                <div id="entregables-list" class="table-container"></div>
            </div>

            <!-- Mis Calificaciones -->
            <div id="mis-calificaciones" class="section">
                <h1>Mis Calificaciones</h1>
                <div class="filters">
                    <input type="text" id="calificaciones-search" placeholder="Buscar...">
                </div>
                <div id="calificaciones-list" class="cards-grid"></div>
            </div>

            <!-- Mis Grupos (GAES) -->
            <div id="mis-grupos" class="section">
                <h1>Mis Grupos (GAES)</h1>
                <button class="btn-primary" onclick="openModal('modal-crear-gaes')">
                    + Crear GAES
                </button>
                <div id="gaes-list" class="cards-grid"></div>
            </div>

            <!-- Mensajes -->
            <div id="mensajes" class="section">
                <h1>Mensajes</h1>
                <button class="btn-primary" onclick="openModal('modal-enviar-mensaje')">
                    + Nuevo Mensaje
                </button>
                <div id="mensajes-list" class="messages-container"></div>
            </div>

            <!-- Notificaciones -->
            <div id="notificaciones" class="section">
                <h1>Notificaciones</h1>
                <div id="notificaciones-full-list" class="notifications-container"></div>
            </div>

            <!-- Configuraci√≥n -->
            <div id="configuracion" class="section">
                <h1>Configuraci√≥n</h1>
                <div class="settings-grid">
                    <button class="settings-btn" onclick="openModal('modal-editar-perfil')">
                        <div class="settings-icon">üë§</div>
                        <span>Editar Perfil</span>
                    </button>
                    <button class="settings-btn" onclick="openModal('modal-cambiar-contrasena')">
                        <div class="settings-icon">üîë</div>
                        <span>Cambiar Contrase√±a</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- Modal Registrar Proyecto -->
    <div id="modal-registrar-proyecto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Proyecto</h2>
                <button class="modal-close" onclick="closeModal('modal-registrar-proyecto')">&times;</button>
            </div>
            <form id="form-registrar-proyecto" class="form-group" onsubmit="registrarProyecto(event)">
                <input type="hidden" id="proyecto-id-edit">
                
                <label>Nombre del Proyecto *</label>
                <input type="text" id="proyecto-nombre" required>
                
                <label>Descripci√≥n</label>
                <textarea id="proyecto-descripcion" rows="4"></textarea>
                
                <label>GAES *</label>
                <select id="proyecto-gaes" required>
                    <option value="">Elige tu GAES</option>
                </select>
                
                <label>Trimestre *</label>
                <select id="proyecto-trimestre" required>
                    <option value="">Elige un trimestre</option>
                </select>
                
                <label>Fecha Inicio</label>
                <input type="date" id="proyecto-fecha-inicio">
                
                <label>Fecha Fin</label>
                <input type="date" id="proyecto-fecha-fin">
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Registrar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-registrar-proyecto')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Subir Entregable -->
    <div id="modal-subir-entregable" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Subir Entregable</h2>
                <button class="modal-close" onclick="closeModal('modal-subir-entregable')">&times;</button>
            </div>
            <form id="form-subir-entregable" class="form-group" onsubmit="subirEntregable(event)">
                <input type="hidden" id="entregable-proyecto" required>
                
                <label>Nombre del Entregable *</label>
                <input type="text" id="entregable-nombre" required>
                
                <label>Descripci√≥n</label>
                <textarea id="entregable-descripcion" rows="3"></textarea>
                
                <label>Tipo de Entrega *</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button type="button" class="btn-secondary" style="flex: 1;" onclick="activarModoEntrega('url')">üîó Por URL</button>
                    <button type="button" class="btn-secondary" style="flex: 1;" onclick="activarModoEntrega('archivo')">üìÅ Por Archivo</button>
                </div>
                
                <div id="entrega-url-container" style="display: block;">
                    <label>URL del Entregable</label>
                    <input type="url" id="entregable-url" placeholder="https://ejemplo.com/archivo">
                </div>
                
                <div id="entrega-archivo-container" style="display: none;">
                    <label>Archivo *</label>
                    <input type="file" id="entregable-archivo" accept=".zip,.rar,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xlsx">
                </div>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Enviar Entregable</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-subir-entregable')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Perfil -->
    <div id="modal-editar-perfil" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <button class="modal-close" onclick="closeModal('modal-editar-perfil')">&times;</button>
            </div>
            <form id="form-editar-perfil" class="form-group">
                <div class="profile-photo-section">
                    <div class="profile-photo-container">
                        <img id="perfil-foto-preview" src="https://via.placeholder.com/150?text=Foto" alt="Foto de Perfil" class="profile-photo">
                        <button type="button" class="btn-change-photo" onclick="document.getElementById('perfil-foto-input').click()">
                            üì∑ Cambiar Foto
                        </button>
                        <input type="file" id="perfil-foto-input" accept="image/*" style="display:none;" onchange="previewFoto(event)">
                    </div>
                </div>
                
                <label>Nombre *</label>
                <input type="text" id="perfil-nombre" required>
                
                <label>Apellido *</label>
                <input type="text" id="perfil-apellido" required>
                
                <label>Correo *</label>
                <input type="email" id="perfil-correo" required>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-editar-perfil')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cambiar Contrase√±a -->
    <div id="modal-cambiar-contrasena" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cambiar Contrase√±a</h2>
                <button class="modal-close" onclick="closeModal('modal-cambiar-contrasena')">&times;</button>
            </div>
            <form id="form-cambiar-contrasena" class="form-group">
                <label>Contrase√±a Actual *</label>
                <input type="password" id="contrasena-actual" required>
                
                <label>Nueva Contrase√±a *</label>
                <input type="password" id="contrasena-nueva" required>
                
                <label>Confirmar Contrase√±a *</label>
                <input type="password" id="contrasena-confirmar" required>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-cambiar-contrasena')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Crear GAES -->
    <div id="modal-crear-gaes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear GAES</h2>
                <button class="modal-close" onclick="closeModal('modal-crear-gaes')">&times;</button>
            </div>
            <form id="form-crear-gaes" class="form-group" onsubmit="crearGaes(event)">
                <label>Nombre del GAES *</label>
                <input type="text" id="gaes-nombre" required placeholder="Ej: GAES-01">
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Crear GAES</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-crear-gaes')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver Integrantes GAES -->
    <div id="modal-ver-integrantes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Integrantes del GAES</h2>
                <button class="modal-close" onclick="closeModal('modal-ver-integrantes')">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="openModal('modal-agregar-integrante')">
                    + Agregar Integrante
                </button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="integrantes-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Agregar Integrante al GAES -->
    <div id="modal-agregar-integrante" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Integrante al GAES</h2>
                <button class="modal-close" onclick="closeModal('modal-agregar-integrante')">&times;</button>
            </div>
            <form id="form-agregar-integrante" class="form-group" onsubmit="agregarIntegrante(event)">
                <input type="hidden" id="gaes-id-integrante">
                
                <label>Seleccionar Aprendiz *</label>
                <select id="aprendiz-select" required>
                    <option value="">Seleccione un aprendiz</option>
                </select>
                
                <label>
                    <input type="checkbox" id="es-lider">
                    Es L√≠der del GAES
                </label>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Agregar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-agregar-integrante')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Validar autenticaci√≥n antes de cargar el dashboard
        function validarAutenticacion() {
            const token = localStorage.getItem('jwtToken');
            const rol = localStorage.getItem('usuarioRol');
            
            console.log('Token:', token ? 'Existe' : 'No existe');
            console.log('Rol guardado:', rol);
            
            // Si no hay token, redirigir al login
            if (!token || !token.trim()) {
                console.log('No hay token, redirigiendo al login');
                window.location.href = '/login';
                return false;
            }
            
            // Validar que sea aprendiz (case-insensitive)
            if (rol && rol.toLowerCase() !== 'aprendiz') {
                console.log('Rol no permitido:', rol);
                window.location.href = '/login';
                return false;
            }
            
            console.log('‚úì Usuario aprendiz autenticado correctamente');
            return true;
        }
        
        // Ejecutar validaci√≥n
        validarAutenticacion();
        </script>

        <!-- Prevenci√≥n de Back Navigation - DEBE SER PRIMERO -->
        <script src="/js/prevent-back-navigation.js"></script>
        
        <!-- Cargar utilidades de API y autenticaci√≥n primero (ANTES de cualquier otro script) -->
        <script src="/js/api-utils.js"></script>
        
        <!-- Actualizar header con datos del usuario autenticado -->
        <script src="/js/actualizar-header-usuario.js"></script>
        
        <script src="/js/aprendiz-dashboard.js"></script>
        <!-- Gr√°ficos din√°micos -->
        <script src="/js/aprendiz-charts.js"></script>
<!-- Scripts -->
<script src="/js/app-init.js"></script>
<script src="/js/aprendiz-registrar-proyecto.js"></script>

</body>
</html>
